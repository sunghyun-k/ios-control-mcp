name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  publish-npm:
    runs-on: macos-15  # arm64 runner, tuist 4.97.2+ requires macOS 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Setup mise
        uses: jdx/mise-action@v2

      - name: Generate Xcode projects
        run: tuist generate --no-open

      - name: Build MCPServer (universal binary)
        run: |
          # arm64 빌드
          xcodebuild -workspace iOSControlMCP.xcworkspace \
            -scheme MCPServer \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -derivedDataPath .build/arm64 \
            ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=NO

          # x86_64 빌드
          xcodebuild -workspace iOSControlMCP.xcworkspace \
            -scheme MCPServer \
            -configuration Release \
            -destination 'generic/platform=macOS' \
            -derivedDataPath .build/x86_64 \
            ARCHS=x86_64 \
            ONLY_ACTIVE_ARCH=NO

          # Universal binary 생성
          lipo -create \
            .build/arm64/Build/Products/Release/MCPServer \
            .build/x86_64/Build/Products/Release/MCPServer \
            -output bin/MCPServer

          chmod +x bin/MCPServer

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
